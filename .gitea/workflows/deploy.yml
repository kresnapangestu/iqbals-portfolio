name: Deploy Portfolio

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Deploy to Production
        run: |
          set -e

          DEPLOY_DIR=/home/pangestu/srv/portfolio
          REPO_URL=git@localhost:kresnapangestu/iqbals-portfolio.git

          echo "ğŸ“¦ Deploying to $DEPLOY_DIR..."

          # Setup Git SSH
          export GIT_SSH_COMMAND="ssh -i /home/pangestu/.ssh/gitea-deploy -p 222 -o StrictHostKeyChecking=no"

          # Clone or pull
          if [ -d "$DEPLOY_DIR/.git" ]; then
            echo "ğŸ”„ Pulling latest changes..."
            cd $DEPLOY_DIR
            git pull $REPO_URL main
          else
            echo "ğŸ“¥ Cloning repository..."
            mkdir -p $DEPLOY_DIR
            git clone $REPO_URL $DEPLOY_DIR
          fi

          # Deploy
          cd $DEPLOY_DIR

          echo "ğŸ³ Building Docker image..."
          docker compose down || true
          docker compose build --no-cache

          echo "ğŸš€ Starting container..."
          docker compose up -d

          echo "âœ… Deployment complete!"
          echo "ğŸŒ Live at: https://kresnapangestu.com"
